<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Type Ahead ğŸ‘€</title>
    <link rel="stylesheet" href="style.css" />
    <style>
    </style>
  </head>
  <body>
    <form class="search-form">
      <input type="text" class="search" placeholder="è¾“å…¥å…³é”®è¯ï¼Œæ‰¾ä¸€é¦–è¯—" />
      <ul class="suggestions"></ul>
    </form>
    <script>
      const endpoint =
        "https://gist.githubusercontent.com/soyaine/81399bb2b24ca1bb5313e1985533c640/raw/bdf7df2cbcf70706c4a5e51a7dfb8c933ed78878/TangPoetry.json";
      const poetrys = [];

      // ä½¿ç”¨ async/await æé«˜å¼‚æ­¥ä»£ç å¯è¯»æ€§
      async function fetchData() {
        try {
          const response = await fetch(endpoint);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          poetrys.push(...data);
        } catch (error) {
          console.error("æ— æ³•è·å–è¯—è¯æ•°æ®:", error);
          // å¯ä»¥åœ¨é¡µé¢ä¸Šç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½çš„æç¤º
          suggestionsEl.innerHTML = `<li>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</li>`;
        }
      }

      function findMatches(wordToMatch, poetrys) {
        if (!wordToMatch) {
          return [];
        }
        const regex = new RegExp(wordToMatch, "gi");
        return poetrys.filter((poet) => {
          // å°†ä½œè€…æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥ä¾¿æœç´¢
          const author = poet.detail_author.join("");
          // æ£€æŸ¥æ ‡é¢˜ã€ä½œè€…æˆ–æ­£æ–‡æ˜¯å¦åŒ¹é…
          return (
            poet.title.match(regex) ||
            author.match(regex) ||
            poet.detail_text.match(regex)
          );
        });
      }

      function displayMatches() {
        const keyword = this.value.trim(); // ä½¿ç”¨ trim() ç§»é™¤å‰åç©ºæ ¼
        if (!keyword) {
          suggestionsEl.innerHTML = ``; 
          return;
        }

        const matches = findMatches(keyword, poetrys);
        const regex = new RegExp(keyword, "gi");

        const html = matches
          .map((poet) => {
            const text = poet.detail_text.replace(
              regex,
              `<span class="hl">${keyword}</span>`
            );
            const title = poet.title.replace(
              regex,
              `<span class="hl">${keyword}</span>`
            );
            const author = poet.detail_author
              .join("")
              .replace(regex, `<span class="hl">${keyword}</span>`);

            return `
                <li>
                    <span class="poet">${text}</span>
                    <span class="title">${title} - ${author}</span>
                </li>
            `;
          })
          .join("");

        console.log(html)

        // å¦‚æœæ²¡æœ‰åŒ¹é…é¡¹ï¼Œç»™å‡ºæç¤º
        suggestionsEl.innerHTML = html || `<li>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯—è¯</li>`;
      }

      const searchEl = document.querySelector(".search");
      const suggestionsEl = document.querySelector(".suggestions");

      // è°ƒç”¨å‡½æ•°è·å–æ•°æ®
      fetchData();

      searchEl.addEventListener("input", displayMatches);
    </script>
  </body>
</html>
